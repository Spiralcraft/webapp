<af:SessionStateFilter
  xmlns:af="class:/spiralcraft/servlet/autofilter"
  xmlns:j="class:/java/lang"
  xmlns:sec="class:/spiralcraft/security"
  xmlns:sa="class:/spiralcraft/webapp/meta"
  xmlns:st="class:/spiralcraft/time"
  xmlns:c="context://code/components"
  >
  <attributeSuffix>resetPassword
  </attributeSuffix>
  
  <constructor>
    [#resetPassword]
    { 
      resetCode:[@j:String]
       ,username:[@j:String]
       ,sendCode
         :=`@{.login=[@sec:Login].@findBySearchName(.username)
             ,.user=[@sa:User].@findByPrincipalId(.login.principalId)
             ,.ticket=[@sec:Ticket].@create
               (.login.principalId
               ,[@st:Chronom].@MINUTE.times(30)
               )
             ,[resetPassword].user.email!=null
                 ?[*c:resetPassword-sendCode].
                   ([resetPassword].user.email
                     ,[resetPassword].user.commonName
                     ,[resetPassword].ticket.code
                   )
                 :@log("Reset code for non-system login is "+[resetPassword].ticket.code)
             ,[resetPassword].state="SENT"
            }`
       ,login:[@sec:Login]
       ,user:[@sa:User]
       ,ticket:[@sec:Ticket]
       ,validatedTicket:[@sec:Ticket]
       ,state:="INIT"
    }
  </constructor>
</af:SessionStateFilter>   
