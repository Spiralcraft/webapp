<rpc:DispatchHandler
  xmlns:rpc="class:/spiralcraft/servlet/rpc/"
  xmlns:t="class:/spiralcraft/task/"
  xmlns:dt="class:/spiralcraft/data/task/"
  xmlns:swm="class:/spiralcraft/webapp/meta"
  xmlns:j="class:/java/lang/"
  xmlns:fn="class:/spiralcraft/lang/functions"
  xmlns:sec="class:/spiralcraft/security"
  >
  <debug>false
  </debug>
  <handlers>
    <rpc:JsonTaskHandler>
      <name>.startSession
      </name>
      <task>
        <t:Eval>
          <contextX>
            [#p] { resetCode:[@j:String] }
          </contextX>
          <x>
            (resetCode!=null
              ?[@sec:Ticket].@findByCode(resetCode)
                { .valid
                    ?([resetPassword]{.validatedTicket=..,.state="VERIFIED"})
                    :([resetPassword]{.validatedTicket=null,.state="FAILED"})
                }
              :null
            )
            {
              { 
                resetCodeValid:=[resetPassword].validatedTicket!=null
                ,username:=[resetPassword].validatedTicket.login.searchname
              }
            }
          </x> 
        </t:Eval>
      </task>
    </rpc:JsonTaskHandler>
    <rpc:JsonTaskHandler>
      <name>.setNewPassword
      </name>
      <task>
        <t:Eval>
          <contextX>
            [#p] { passwordDigest:[@j:String] }
          </contextX>
          <x>.{ [resetPassword].validatedTicket.login.[*dt:Edit{ action:=`.digestpass=[p].passwordDigest`}].().@log(.)
                ,[resetPassword].validatedTicket.[*dt:Edit{ action:=`.revoked=true` }].().@log(.)
                ,{ resetCodeValid:= false }
              }
          </x> 
        </t:Eval>
      </task>
    </rpc:JsonTaskHandler>
    
  </handlers>
</rpc:DispatchHandler>
